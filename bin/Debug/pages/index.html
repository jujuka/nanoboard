<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"> 
<script type="text/javascript" src="bpgdec8a.js"></script>
<script src='../scripts/jquery.min.js'> </script>
<style>
* {
  font-family: 'Verdana', sans-serif;
  font-size: 13px;
}

.reply {
  margin: 0.5em;
}

.reply-button {
  float: right;
  margin-bottom: 0.4em;
}

gr {
  color: green;
}

textarea {
  width: 300px;
  height: 130px;
  outline: 0;
}

.post {
  background-color: #ddd;
  border: 1px solid #aaa;
  border-radius: .4em;
  margin: .4em 0;
  max-width: 500px;
}

.reply-div {
  display: inline-block;
}

img {
	border: 1px dotted white;
	max-width: 100px;
}

.full {
	max-width: 100%;
	border-width: 0;
}

a {
  text-decoration: none;
  color: darkorange;
}

a:hover {
  color: salmon;
}

.high {
  background-color: moccasin;
  border-style: dotted;
}

sp {
  background-color: #222;
}

.post-inner {
  word-break: normal;
  overflow: auto;
  max-height: 36em;
  padding: 0em 0.25em;
  margin: .5em;
}
</style>
<script>
var _categories = 'bdd4b5fc1b3a933367bc6830fef72a35';
var _mainpost = 'f682830a470200d738d32c69e6c2b8a4';
var _rootpost = '00000000000000000000000000000000';
var _depth = 0;
var thisPosts = [];

/*! @source http://purl.eligrey.com/github/FileSaver.js/blob/master/FileSaver.js */
var saveAs=saveAs||function(view){"use strict";if(typeof navigator!=="undefined"&&/MSIE [1-9]\./.test(navigator.userAgent)){return}var doc=view.document,get_URL=function(){return view.URL||view.webkitURL||view},save_link=doc.createElementNS("http://www.w3.org/1999/xhtml","a"),can_use_save_link="download"in save_link,click=function(node){var event=new MouseEvent("click");node.dispatchEvent(event)},is_safari=/Version\/[\d\.]+.*Safari/.test(navigator.userAgent),webkit_req_fs=view.webkitRequestFileSystem,req_fs=view.requestFileSystem||webkit_req_fs||view.mozRequestFileSystem,throw_outside=function(ex){(view.setImmediate||view.setTimeout)(function(){throw ex},0)},force_saveable_type="application/octet-stream",fs_min_size=0,arbitrary_revoke_timeout=500,revoke=function(file){var revoker=function(){if(typeof file==="string"){get_URL().revokeObjectURL(file)}else{file.remove()}};if(view.chrome){revoker()}else{setTimeout(revoker,arbitrary_revoke_timeout)}},dispatch=function(filesaver,event_types,event){event_types=[].concat(event_types);var i=event_types.length;while(i--){var listener=filesaver["on"+event_types[i]];if(typeof listener==="function"){try{listener.call(filesaver,event||filesaver)}catch(ex){throw_outside(ex)}}}},auto_bom=function(blob){if(/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(blob.type)){return new Blob(["\ufeff",blob],{type:blob.type})}return blob},FileSaver=function(blob,name,no_auto_bom){if(!no_auto_bom){blob=auto_bom(blob)}var filesaver=this,type=blob.type,blob_changed=false,object_url,target_view,dispatch_all=function(){dispatch(filesaver,"writestart progress write writeend".split(" "))},fs_error=function(){if(target_view&&is_safari&&typeof FileReader!=="undefined"){var reader=new FileReader;reader.onloadend=function(){var base64Data=reader.result;target_view.location.href="data:attachment/file"+base64Data.slice(base64Data.search(/[,;]/));filesaver.readyState=filesaver.DONE;dispatch_all()};reader.readAsDataURL(blob);filesaver.readyState=filesaver.INIT;return}if(blob_changed||!object_url){object_url=get_URL().createObjectURL(blob)}if(target_view){target_view.location.href=object_url}else{var new_tab=view.open(object_url,"_blank");if(new_tab==undefined&&is_safari){view.location.href=object_url}}filesaver.readyState=filesaver.DONE;dispatch_all();revoke(object_url)},abortable=function(func){return function(){if(filesaver.readyState!==filesaver.DONE){return func.apply(this,arguments)}}},create_if_not_found={create:true,exclusive:false},slice;filesaver.readyState=filesaver.INIT;if(!name){name="download"}if(can_use_save_link){object_url=get_URL().createObjectURL(blob);setTimeout(function(){save_link.href=object_url;save_link.download=name;click(save_link);dispatch_all();revoke(object_url);filesaver.readyState=filesaver.DONE});return}if(view.chrome&&type&&type!==force_saveable_type){slice=blob.slice||blob.webkitSlice;blob=slice.call(blob,0,blob.size,force_saveable_type);blob_changed=true}if(webkit_req_fs&&name!=="download"){name+=".download"}if(type===force_saveable_type||webkit_req_fs){target_view=view}if(!req_fs){fs_error();return}fs_min_size+=blob.size;req_fs(view.TEMPORARY,fs_min_size,abortable(function(fs){fs.root.getDirectory("saved",create_if_not_found,abortable(function(dir){var save=function(){dir.getFile(name,create_if_not_found,abortable(function(file){file.createWriter(abortable(function(writer){writer.onwriteend=function(event){target_view.location.href=file.toURL();filesaver.readyState=filesaver.DONE;dispatch(filesaver,"writeend",event);revoke(file)};writer.onerror=function(){var error=writer.error;if(error.code!==error.ABORT_ERR){fs_error()}};"writestart progress write abort".split(" ").forEach(function(event){writer["on"+event]=filesaver["on"+event]});writer.write(blob);filesaver.abort=function(){writer.abort();filesaver.readyState=filesaver.DONE};filesaver.readyState=filesaver.WRITING}),fs_error)}),fs_error)};dir.getFile(name,{create:false},abortable(function(file){file.remove();save()}),abortable(function(ex){if(ex.code===ex.NOT_FOUND_ERR){save()}else{fs_error()}}))}),fs_error)}),fs_error)},FS_proto=FileSaver.prototype,saveAs=function(blob,name,no_auto_bom){return new FileSaver(blob,name,no_auto_bom)};if(typeof navigator!=="undefined"&&navigator.msSaveOrOpenBlob){return function(blob,name,no_auto_bom){if(!no_auto_bom){blob=auto_bom(blob)}return navigator.msSaveOrOpenBlob(blob,name||"download")}}FS_proto.abort=function(){var filesaver=this;filesaver.readyState=filesaver.DONE;dispatch(filesaver,"abort")};FS_proto.readyState=FS_proto.INIT=0;FS_proto.WRITING=1;FS_proto.DONE=2;FS_proto.error=FS_proto.onwritestart=FS_proto.onprogress=FS_proto.onwrite=FS_proto.onabort=FS_proto.onerror=FS_proto.onwriteend=null;return saveAs}(typeof self!=="undefined"&&self||typeof window!=="undefined"&&window||this.content);if(typeof module!=="undefined"&&module.exports){module.exports.saveAs=saveAs}else if(typeof define!=="undefined"&&define!==null&&define.amd!=null){define([],function(){return saveAs})}

function shortenHash(hash) {
	return hash.substring(0,4) + '..' + hash.substring(28,32);
}

function replaceAll(text, search, replace) {
  return text.split(search).join(replace);
}

(function($) {
  //jQuery.fx.off = true;
  $.fn.extend({
    addTemporaryClass: function(className, duration) {
      var elements = this;
      setTimeout(function() {
        elements.removeClass(className);
      }, duration);
      return this.each(function() {
        $(this).addClass(className);
      });
    }
  });
})(jQuery);

function escapeTags(text) {
  return text
    .replace(/>/gim, '&gt;')
    .replace(/</gim, '&lt;');
}

function detectImages(text) {
  var prefix = 'data:image/jpeg;base64,';
  var matches = text.match(/\[img=[A-Za-z0-9+\/=]{4,64512}\]/g);
  if (matches != null) {
    for (var i = 0; i < matches.length; i++) {
      var value = matches[i].toString();
      value = value.substring(5);
      value = value.substring(0, value.length - 1);
      value = '<img src="' + prefix + value + '" />';
      text = replaceAll(text, matches[i], value);
    }
  }
  return text;
}

function applyFormatting(text) {
  text = text.replace(/\[sp(oiler|)\]/gim, '[x]');
  text = text.replace(/\[\/sp(oiler|)\]/gim, '[/x]');
  var tags = 'biusx';
  for (var x = 0; x < tags.length; x++) {
    var ch = tags.charAt(x);
    text = text
      .replace(new RegExp("\\[" + ch + "\\]", 'gim'), '<' + ch + '>')
      .replace(new RegExp("\\[/" + ch + "\\]", 'gim'), '</' + ch + '>');
  }
  text = detectImages(text);
  text = replaceAll(text, '\n', '<br/>');
  text = replaceAll(text, '  ', '&nbsp; ')
  return text
    .replace(/<x>/gim, '<sp>')
    .replace(/<\/x>/gim, '</sp>');
}

function sendPostToDb(post) {
  $.post('../api/add/' + post.replyTo, post.message)
  	.done(function(response){
  		addPost(JSON.parse(response), function(d){ d.insertAfter($('#'+post.replyTo)); }, false)
  			.addTemporaryClass('high', 1000)
  			.css('margin-left', parseInt($('#'+post.replyTo).css('margin-left'))+10+'px');
  	});
}

function deletePostFromDb(hash) {
  $.post('../api/delete/' + hash);
}

function addReplyForm(id) {
  var form = $('<div>')
    .addClass('post').addClass('reply-div')
    .insertAfter($('#' + id))
    .css('margin-left', parseInt($('#' + id).css('margin-left')) + 10 + 'px')
    .append($('<div>').addClass('reply')
      .append($('<textarea>'))
      .append($('<br>'))
      .append($('<button>')
        .addClass('reply-button')
        .text('Cancel')
        .click(function() {
          $(this).parent().parent().remove();
        }))
      .append($('<button>')
        .text('Send')
        .addClass('reply-button')
        .click(function() {
          sendPostToDb({
            'replyTo': id,
            'message': $(this).parent().find('textarea').val()
          });
          $(this).parent().parent().remove();
        }))
    );
    var offset = form.offset();
    offset.top -= 100;
    $('html, body').animate({
    	scrollTop: offset.top,
    	scrollLeft: offset.left
	});
}

/**

*

*  Base64 encode / decode

*  http://www.webtoolkit.info/

*

**/

 


var Base64 = {

 


    // private property


    _keyStr : "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",

 


    // public method for encoding


    encode : function (input) {


        var output = "";


        var chr1, chr2, chr3, enc1, enc2, enc3, enc4;


        var i = 0;

 


        input = Base64._utf8_encode(input);

 


        while (i < input.length) {

 


            chr1 = input.charCodeAt(i++);


            chr2 = input.charCodeAt(i++);


            chr3 = input.charCodeAt(i++);

 


            enc1 = chr1 >> 2;


            enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);


            enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);


            enc4 = chr3 & 63;

 


            if (isNaN(chr2)) {


                enc3 = enc4 = 64;


            } else if (isNaN(chr3)) {


                enc4 = 64;


            }

 


            output = output +


            this._keyStr.charAt(enc1) + this._keyStr.charAt(enc2) +


            this._keyStr.charAt(enc3) + this._keyStr.charAt(enc4);

 


        }

 


        return output;


    },

 


    // public method for decoding


    decode : function (input) {


        var output = "";


        var chr1, chr2, chr3;


        var enc1, enc2, enc3, enc4;


        var i = 0;

 


        input = input.replace(/[^A-Za-z0-9\+\/\=]/g, "");

 


        while (i < input.length) {

 


            enc1 = this._keyStr.indexOf(input.charAt(i++));


            enc2 = this._keyStr.indexOf(input.charAt(i++));


            enc3 = this._keyStr.indexOf(input.charAt(i++));


            enc4 = this._keyStr.indexOf(input.charAt(i++));

 


            chr1 = (enc1 << 2) | (enc2 >> 4);


            chr2 = ((enc2 & 15) << 4) | (enc3 >> 2);


            chr3 = ((enc3 & 3) << 6) | enc4;

 


            output = output + String.fromCharCode(chr1);

 


            if (enc3 != 64) {


                output = output + String.fromCharCode(chr2);


            }


            if (enc4 != 64) {


                output = output + String.fromCharCode(chr3);


            }

 


        }

 


        output = Base64._utf8_decode(output);

 


        return output;

 


    },

 


    // private method for UTF-8 encoding


    _utf8_encode : function (string) {


        string = string.replace(/\r\n/g,"\n");


        var utftext = "";

 


        for (var n = 0; n < string.length; n++) {

 


            var c = string.charCodeAt(n);

 


            if (c < 128) {


                utftext += String.fromCharCode(c);


            }


            else if((c > 127) && (c < 2048)) {


                utftext += String.fromCharCode((c >> 6) | 192);


                utftext += String.fromCharCode((c & 63) | 128);


            }


            else {


                utftext += String.fromCharCode((c >> 12) | 224);


                utftext += String.fromCharCode(((c >> 6) & 63) | 128);


                utftext += String.fromCharCode((c & 63) | 128);


            }

 


        }

 


        return utftext;


    },

 


    // private method for UTF-8 decoding


    _utf8_decode : function (utftext) {


        var string = "";


        var i = 0;


        var c = c1 = c2 = 0;

 


        while ( i < utftext.length ) {

 


            c = utftext.charCodeAt(i);

 


            if (c < 128) {


                string += String.fromCharCode(c);


                i++;


            }


            else if((c > 191) && (c < 224)) {


                c2 = utftext.charCodeAt(i+1);


                string += String.fromCharCode(((c & 31) << 6) | (c2 & 63));


                i += 2;


            }


            else {


                c2 = utftext.charCodeAt(i+1);


                c3 = utftext.charCodeAt(i+2);


                string += String.fromCharCode(((c & 15) << 12) | ((c2 & 63) << 6) | (c3 & 63));


                i += 3;


            }

 


        }

 


        return string;


    }

 

}

function addPost(post, appendFunc, hasShowButton) {
  thisPosts.push(post);
  if (_depth > 1) hasShowButton = false;
  var d = $(document.createElement('div'));
  d
    .addClass('post')
    .attr('id', post.hash);
  d
    .append('<gr>#' + shortenHash(post.hash) + '&nbsp;</gr>');
  $('<a>')
    .attr('href', '#' + post.replyTo)
    .click(function() {
      $('#' + post.replyTo)
        .addTemporaryClass('high', 1000)
    })
    .appendTo(d)
    .html('^' + shortenHash(post.replyTo));
  d.append('&nbsp;');
  d
    .append($('<a>')
      .attr('href', 'javascript:void(0)')
      .text('[Reply]')
      .click(function() {
        addReplyForm(post.hash);
        d.next().find('textarea').focus();
      }));
  if (hasShowButton) {
	  d.append('&nbsp;');
	  d
	    .append($('<a>')
	      .attr('href', 'javascript:void(0)')
	      .text('[Show]')
	      .click(function() {
	      	_depth += 1;
	      	loadThread(post.hash);
	      }));
  }
  d.append('&nbsp;');
  d
    .append($('<a>')
      .attr('href', 'javascript:void(0)')
      .text('[X]')
      .attr('title', 'Double click to delete post.')
      .dblclick(function() {
        deletePostFromDb(post.hash);
        d.remove();
      }));
  appendFunc(d);
  //d.appendTo($('#thread'));
  $('<div>')
    .addClass('post-inner')
    .html(applyFormatting(escapeTags(Base64.decode(post.message))))
    .appendTo(d);
  d.slideUp(0);
  d.slideDown(250);
  d.find('img').click(function(){
  	$(this).toggleClass('full');
  });
  return d;
}

function loadReplies(hash, offset, highlight) {
	$.get('../api/replies/' + hash)
		.done(function(arr){
			arr = JSON.parse(arr);
			if (arr.length == 0) return;
			for (var i = arr.length-1; i >= 0; i--) {
				var p = addPost(arr[i], function(d) { d.insertAfter($('#'+hash)); }, false)
					.css('margin-left', offset * 10 + 'px');
				loadReplies(arr[i].hash, offset + 1, highlight);
        if (highlight == arr[i].hash) {
          p.addTemporaryClass('high', 2000)
        }
			}
		});
}

function updateStatusLine() {
  $.get('../api/count')
    .done(function(cnt){
      $('#statusd')
        .html(
          '<a href=javascript:void(0)>Posts (including deleted): '+cnt+'</a>'
        );
    });
}

function loadThread(hash, highlight) {
  thisPosts = [];
  updateStatusLine();
	$.get('../api/replies/' + hash)
		.done(function(arr){
			arr = JSON.parse(arr);
			if (arr.length > 0) {
				$('#thread').empty();
			} else { _depth -= 1; return; }
			$.get('../api/get/' + hash)
				.done(function(post){
					post = JSON.parse(post);
					if (_depth > 0) {
						$('#thread').append(
							$('<a>')
								.attr('href','#')
								.text('[Up]')
								.click(function(){
									_depth -= 1;
									loadThread(post.replyTo);
								}));
					}
					$('#thread').append('&nbsp;');
					$('#thread').append(
						$('<a>')
							.attr('href','#')
							.text('[Refresh]')
							.click(function(){
								loadThread(hash);
							}));
					addPost(post, function(d){ d.appendTo($('#thread')); }, false);
					for (var i = 0; i < arr.length; i++) {
						var p = addPost(arr[i], function(d) { d.appendTo($('#thread')); }, true)
							.css('margin-left',  10 + 'px');
            if (highlight == arr[i].hash) {
              p.addTemporaryClass('high', 2000)
            }
						if (_depth > 1) {
							loadReplies(arr[i].hash, 2, highlight);
						}
					}
				});
		});
}

function loadRootThread(hash) {
  var first = hash;
  var prev = hash;
  var fn = function(){
    $.get('../api/get/' + hash)
      .done(function(p){
        p = JSON.parse(p);
        if (p.replyTo == _categories)
        {
          _depth = 2;
          loadThread(prev, first);
          return;
        }
        prev = p.hash;
        hash = p.replyTo;
        fn();
      });
  };
  fn();
}

function showLast(N){
    $.get('../api/pcount')
      .done(function(cnt){
        cnt = parseInt(cnt);
        $.get('../api/prange/'+Math.max(cnt-N,0)+'-'+N)
          .done(function(arr){
            arr = JSON.parse(arr);
            if (arr.length > 0) {
              $('#thread').empty();
            } else { return; }
            for (var i = arr.length - 1; i >= 0; i--) {
              var p = addPost(arr[i], function(d) { d.appendTo($('#thread')); }, false);
              if (arr[i].hash != _categories && 
                  arr[i].replyTo != _categories && 
                  arr[i].replyTo != _rootpost)
              p.append(
                $('<a>')
                  .attr('href', 'javascript:void(0)')
                  .text('[Thread]')
                  .click(function(){
                    loadRootThread($(this).parent().attr('id'));
                  })
                );
            }
          });
      });
  }

$(function() {
  $('#last10a').click(function(){showLast(10);});
  $('#last50a').click(function(){showLast(50);});
  $('#last100a').click(function(){showLast(100);});
  $('#last500a').click(function(){showLast(500);});
  $('#maina').click(function(){_depth = 0;loadThread(_categories);});
  $('#tojsona').click(function(){
    var po = new Object();
    po["posts"] = thisPosts;
    var str = JSON.stringify(po);
    var blob = new Blob([str], {type: "text/plain;charset=utf-8"});
    saveAs(blob, "posts.txt");
  });
  loadThread(_categories);
});
</script>
</head>
<body>
<a style='font-size:300%;' href='javascript:void(0)'>Nanoboard<sup>2.0</sup></a>
<div>
<a id='maina' href='#'>[Main]</a>
<a id='last50a' href='#'>[Last 50]</a>
<a id='last100a' href='#'>[100]</a>
<a id='last500a' href='#'>[500]</a>
<a id='last10a' href='#'>[10]</a>
<a href='img2base64.html' target='_blank'>[Image→Base64]</a>
<a href='../shutdown'>[Shutdown]</a>
</div>
<hr>
<div id='thread'>

</div>
<br/>
<a id='tojsona' href='#'>[This page→JSON]</a>
<hr/>
<div id='statusd'></div>
</body>
</html>