<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"> 
<script type="text/javascript" src="bpgdec8a.js"></script>
<script src='../scripts/jquery.min.js'> </script>
<style>
* {
  font-family: 'Verdana', sans-serif;
  font-size: 13px;
}

.reply {
  margin: 0.5em;
}

.reply-button {
  float: right;
  margin-bottom: 0.4em;
}

gr {
  color: green;
}

textarea {
  width: 300px;
  height: 130px;
  outline: 0;
}

.post {
  background-color: #ddd;
  border: 1px solid #aaa;
  border-radius: .4em;
  margin: .4em 0;
  max-width: 500px;
}

.reply-div {
  display: inline-block;
}

img {
	border: 1px dotted white;
	max-width: 100px;
}

.full {
	max-width: 100%;
	border-width: 0;
}

a {
  text-decoration: none;
  color: darkorange;
}

a:hover {
  color: salmon;
}

.high {
  background-color: moccasin;
  border-style: dotted;
}

sp {
  background-color: #222;
}

.post-inner {
  word-break: normal;
  overflow: auto;
  max-height: 36em;
  padding: 0em 0.25em;
  margin: .5em;
}
</style>
<script>
var _categories = 'bdd4b5fc1b3a933367bc6830fef72a35';
var _mainpost = 'f682830a470200d738d32c69e6c2b8a4';
var _rootpost = '00000000000000000000000000000000';
var _depth = 0;

function shortenHash(hash) {
	return hash.substring(0,4) + '..' + hash.substring(28,32);
}

function replaceAll(text, search, replace) {
  return text.split(search).join(replace);
}

(function($) {
  //jQuery.fx.off = true;
  $.fn.extend({
    addTemporaryClass: function(className, duration) {
      var elements = this;
      setTimeout(function() {
        elements.removeClass(className);
      }, duration);
      return this.each(function() {
        $(this).addClass(className);
      });
    }
  });
})(jQuery);

function escapeTags(text) {
  return text
    .replace(/>/gim, '&gt;')
    .replace(/</gim, '&lt;');
}

function detectImages(text) {
  var prefix = 'data:image/jpeg;base64,';
  var matches = text.match(/\[img=[A-Za-z0-9+\/=]{4,64512}\]/g);
  if (matches != null) {
    for (var i = 0; i < matches.length; i++) {
      var value = matches[i].toString();
      value = value.substring(5);
      value = value.substring(0, value.length - 1);
      value = '<img src="' + prefix + value + '" />';
      text = replaceAll(text, matches[i], value);
    }
  }
  return text;
}

function applyFormatting(text) {
  text = text.replace(/\[sp(oiler|)\]/gim, '[x]');
  text = text.replace(/\[\/sp(oiler|)\]/gim, '[/x]');
  var tags = 'biusx';
  for (var x = 0; x < tags.length; x++) {
    var ch = tags.charAt(x);
    text = text
      .replace(new RegExp("\\[" + ch + "\\]", 'gim'), '<' + ch + '>')
      .replace(new RegExp("\\[/" + ch + "\\]", 'gim'), '</' + ch + '>');
  }
  text = detectImages(text);
  text = replaceAll(text, '\n', '<br/>');
  text = replaceAll(text, '  ', '&nbsp; ')
  return text
    .replace(/<x>/gim, '<sp>')
    .replace(/<\/x>/gim, '</sp>');
}

function sendPostToDb(post) {
  $.post('../api/add/' + post.replyTo, post.message)
  	.done(function(response){
  		addPost(JSON.parse(response), function(d){ d.insertAfter($('#'+post.replyTo)); }, false)
  			.addTemporaryClass('high', 1000)
  			.css('margin-left', parseInt($('#'+post.replyTo).css('margin-left'))+10+'px');
  	});
}

function deletePostFromDb(hash) {
  $.post('../api/delete/' + hash);
}

function addReplyForm(id) {
  var form = $('<div>')
    .addClass('post').addClass('reply-div')
    .insertAfter($('#' + id))
    .css('margin-left', parseInt($('#' + id).css('margin-left')) + 10 + 'px')
    .append($('<div>').addClass('reply')
      .append($('<textarea>'))
      .append($('<br>'))
      .append($('<button>')
        .addClass('reply-button')
        .text('Cancel')
        .click(function() {
          $(this).parent().parent().remove();
        }))
      .append($('<button>')
        .text('Send')
        .addClass('reply-button')
        .click(function() {
          sendPostToDb({
            'replyTo': id,
            'message': $(this).parent().find('textarea').val()
          });
          $(this).parent().parent().remove();
        }))
    );
    var offset = form.offset();
    offset.top -= 100;
    $('html, body').animate({
    	scrollTop: offset.top,
    	scrollLeft: offset.left
	});
}

function addPost(post, appendFunc, hasShowButton) {
  if (_depth > 1) hasShowButton = false;
  var d = $(document.createElement('div'));
  d
    .addClass('post')
    .attr('id', post.hash);
  d
    .append('<gr>#' + shortenHash(post.hash) + '&nbsp;</gr>');
  $('<a>')
    .attr('href', '#' + post.replyTo)
    .click(function() {
      $('#' + post.replyTo)
        .addTemporaryClass('high', 1000)
    })
    .appendTo(d)
    .html('^' + shortenHash(post.replyTo));
  d.append('&nbsp;');
  d
    .append($('<a>')
      .attr('href', 'javascript:void(0)')
      .text('[Reply]')
      .click(function() {
        addReplyForm(post.hash);
        d.next().find('textarea').focus();
      }));
  if (hasShowButton) {
	  d.append('&nbsp;');
	  d
	    .append($('<a>')
	      .attr('href', 'javascript:void(0)')
	      .text('[Show]')
	      .click(function() {
	      	_depth += 1;
	      	loadThread(post.hash);
	      }));
  }
  d.append('&nbsp;');
  d
    .append($('<a>')
      .attr('href', 'javascript:void(0)')
      .text('[X]')
      .attr('title', 'Double click to delete post.')
      .dblclick(function() {
        deletePostFromDb(post.hash);
        d.remove();
      }));
  appendFunc(d);
  //d.appendTo($('#thread'));
  $('<div>')
    .addClass('post-inner')
    .html(applyFormatting(escapeTags(post.message)))
    .appendTo(d);
  d.slideUp(0);
  d.slideDown(250);
  d.find('img').click(function(){
  	$(this).toggleClass('full');
  });
  return d;
}

function loadReplies(hash, offset, highlight) {
	$.get('../api/replies/' + hash)
		.done(function(arr){
			arr = JSON.parse(arr);
			if (arr.length == 0) return;
			for (var i = arr.length-1; i >= 0; i--) {
				var p = addPost(arr[i], function(d) { d.insertAfter($('#'+hash)); }, false)
					.css('margin-left', offset * 10 + 'px');
				loadReplies(arr[i].hash, offset + 1, highlight);
        if (highlight == arr[i].hash) {
          p.addTemporaryClass('high', 2000)
        }
			}
		});
}

function loadThread(hash, highlight) {
	$.get('../api/replies/' + hash)
		.done(function(arr){
			arr = JSON.parse(arr);
			if (arr.length > 0) {
				$('#thread').empty();
			} else { return; }
			$.get('../api/get/' + hash)
				.done(function(post){
					post = JSON.parse(post);
					if (_depth > 0) {
						$('#thread').append(
							$('<a>')
								.attr('href','#')
								.text('[Up]')
								.click(function(){
									_depth -= 1;
									loadThread(post.replyTo);
								}));
					}
					$('#thread').append('&nbsp;');
					$('#thread').append(
						$('<a>')
							.attr('href','#')
							.text('[Refresh]')
							.click(function(){
								loadThread(hash);
							}));
					addPost(post, function(d){ d.appendTo($('#thread')); }, false);
					for (var i = 0; i < arr.length; i++) {
						var p = addPost(arr[i], function(d) { d.appendTo($('#thread')); }, true)
							.css('margin-left',  10 + 'px');
            if (highlight == arr[i].hash) {
              p.addTemporaryClass('high', 2000)
            }
						if (_depth > 1) {
							loadReplies(arr[i].hash, 2, highlight);
						}
					}
				});
		});
}

function loadRootThread(hash) {
  var first = hash;
  var prev = hash;
  var fn = function(){
    $.get('../api/get/' + hash)
      .done(function(p){
        p = JSON.parse(p);
        if (p.replyTo == _categories)
        {
          _depth = 2;
          loadThread(prev, first);
          return;
        }
        prev = p.hash;
        hash = p.replyTo;
        fn();
      });
  };
  fn();
}

$(function() {
  $('#lasta').click(function(){
    $.get('../api/pcount')
      .done(function(cnt){
        cnt = parseInt(cnt);
        $.get('../api/prange/'+Math.max(cnt-50,0)+'-'+50)
          .done(function(arr){
            arr = JSON.parse(arr);
            if (arr.length > 0) {
              $('#thread').empty();
            } else { return; }
            for (var i = arr.length - 1; i >= 0; i--) {
              var p = addPost(arr[i], function(d) { d.appendTo($('#thread')); }, false);
              p.append(
                $('<a>')
                  .attr('href', 'javascript:void(0)')
                  .text('[Thread]')
                  .click(function(){
                    loadRootThread($(this).parent().attr('id'));
                  })
                );
            }
          });
      });
  });

  loadThread(_categories);
});
</script>
</head>
<body>
<div>
<a id='lasta' href='#'>[Last]</a>
<a href='img2base64.html' target='_blank'>[Imageâ†’Base64]</a>
<a href='../shutdown'>[Shutdown]</a>
</div>
<hr>
<div id='thread'>

</div>
</body>
</html>